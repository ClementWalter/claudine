#cloud-config
# =============================================================================
# Scaleway Server Initialization - SOC2/ISO27001 Compliant
# =============================================================================
# This cloud-init configuration applies comprehensive security hardening:
# - SOC2 CC6.1: SSH key-only authentication
# - SOC2 CC6.6: UFW firewall with deny-by-default
# - SOC2 CC6.7: Fail2ban brute-force protection
# - SOC2 CC7.1: Auditd kernel-level logging
# - ISO A.12.4: Log rotation with archival
# - ISO A.12.6: Unattended security upgrades
# =============================================================================

# Upgrade packages on first boot
package_update: true
package_upgrade: true

# Install required packages
packages:
  # Container runtime
  - docker.io
  - docker-compose
  - containerd
  # Security (SOC2 CC6.6, CC6.7)
  - ufw
  - fail2ban
  # Audit logging (SOC2 CC7.1)
  - auditd
  - audispd-plugins
  # Monitoring
  - htop
  - iotop
  - sysstat
  # Utilities
  - curl
  - wget
  - jq
  - unzip
  # Automatic security updates (ISO A.12.6)
  - unattended-upgrades
  - apt-listchanges
  # S3 tools for log archival
  - awscli
  - s3cmd

# Create required directories
runcmd:
  # =========================================================================
  # Docker Setup
  # =========================================================================
  - systemctl enable docker
  - systemctl start docker
  - usermod -aG docker root

  # Create deploy user with docker access
  - useradd -m -s /bin/bash -G docker deploy
  - mkdir -p /home/deploy/.ssh
  - cp /root/.ssh/authorized_keys /home/deploy/.ssh/
  - chown -R deploy:deploy /home/deploy/.ssh
  - chmod 700 /home/deploy/.ssh
  - chmod 600 /home/deploy/.ssh/authorized_keys

  # =========================================================================
  # SSH Hardening (SOC2 CC6.1 - Logical Access)
  # =========================================================================
  - |
    cat > /etc/ssh/sshd_config.d/hardening.conf << 'SSHEOF'
    # SOC2 CC6.1: SSH Hardening Configuration

    # Disable password authentication - key-only access
    PasswordAuthentication no
    ChallengeResponseAuthentication no
    UsePAM yes

    # Disable root login (use deploy user instead)
    PermitRootLogin prohibit-password

    # Disable empty passwords
    PermitEmptyPasswords no

    # Limit authentication attempts
    MaxAuthTries 3
    MaxSessions 5

    # Connection timeout
    ClientAliveInterval 300
    ClientAliveCountMax 2

    # Disable X11 and agent forwarding
    X11Forwarding no
    AllowAgentForwarding no
    AllowTcpForwarding no

    # Use strong crypto
    KexAlgorithms curve25519-sha256@libssh.org,ecdh-sha2-nistp521,ecdh-sha2-nistp384,ecdh-sha2-nistp256,diffie-hellman-group-exchange-sha256
    Ciphers chacha20-poly1305@openssh.com,aes256-gcm@openssh.com,aes128-gcm@openssh.com,aes256-ctr,aes192-ctr,aes128-ctr
    MACs hmac-sha2-512-etm@openssh.com,hmac-sha2-256-etm@openssh.com,umac-128-etm@openssh.com

    # Logging
    LogLevel VERBOSE
    SSHEOF
  - systemctl restart sshd
  # =========================================================================
  # UFW Firewall (SOC2 CC6.6 - System Boundaries)
  # =========================================================================
  - ufw default deny incoming
  - ufw default allow outgoing
  - ufw allow 22/tcp comment 'SSH'
  - ufw allow 80/tcp comment 'HTTP'
  - ufw allow 443/tcp comment 'HTTPS'
  - ufw --force enable
  - systemctl enable ufw

  # =========================================================================
  # Fail2ban (SOC2 CC6.7 - Threat Detection)
  # =========================================================================
  - |
    cat > /etc/fail2ban/jail.local << 'F2BEOF'
    # SOC2 CC6.7: Fail2ban Configuration

    [DEFAULT]
    # Ban for 1 hour, increasing with each offense
    bantime = 3600
    bantime.increment = true
    bantime.factor = 2
    bantime.maxtime = 86400

    # Allow 3 retries in 10 minutes
    findtime = 600
    maxretry = 3

    # Email notifications (configure SMTP for production)
    # destemail = security@example.com
    # sender = fail2ban@example.com
    # action = %(action_mwl)s

    [sshd]
    enabled = true
    port = ssh
    filter = sshd
    logpath = /var/log/auth.log
    maxretry = 3
    bantime = 3600

    [sshd-ddos]
    enabled = true
    port = ssh
    filter = sshd-ddos
    logpath = /var/log/auth.log
    maxretry = 5
    bantime = 7200
    F2BEOF
  - systemctl enable fail2ban
  - systemctl restart fail2ban

  # =========================================================================
  # Auditd (SOC2 CC7.1 - System Monitoring)
  # =========================================================================
  - |
    cat > /etc/audit/rules.d/compliance.rules << 'AUDITEOF'
    # SOC2 CC7.1: Audit Rules for Compliance

    # Delete all existing rules
    -D

    # Set buffer size
    -b 8192

    # Failure mode: 1 = printk, 2 = panic
    -f 1

    # Monitor sudoers file changes
    -w /etc/sudoers -p wa -k sudoers_changes
    -w /etc/sudoers.d/ -p wa -k sudoers_changes

    # Monitor SSH configuration
    -w /etc/ssh/sshd_config -p wa -k sshd_config
    -w /etc/ssh/sshd_config.d/ -p wa -k sshd_config

    # Monitor authentication files
    -w /etc/passwd -p wa -k identity
    -w /etc/group -p wa -k identity
    -w /etc/shadow -p wa -k identity
    -w /etc/gshadow -p wa -k identity

    # Monitor login/logout events
    -w /var/log/lastlog -p wa -k logins
    -w /var/log/faillog -p wa -k logins
    -w /var/run/utmp -p wa -k session
    -w /var/log/wtmp -p wa -k session
    -w /var/log/btmp -p wa -k session

    # Monitor privilege escalation
    -a always,exit -F arch=b64 -S execve -F euid=0 -F auid>=1000 -F auid!=4294967295 -k privileged_commands
    -a always,exit -F arch=b32 -S execve -F euid=0 -F auid>=1000 -F auid!=4294967295 -k privileged_commands

    # Monitor sudo usage
    -w /usr/bin/sudo -p x -k sudo_usage
    -w /usr/bin/su -p x -k su_usage

    # Monitor Docker commands
    -w /usr/bin/docker -p x -k docker_commands
    -w /usr/bin/dockerd -p x -k docker_daemon
    -w /var/lib/docker -p wa -k docker_files

    # Monitor network configuration changes
    -w /etc/hosts -p wa -k network_changes
    -w /etc/network/ -p wa -k network_changes
    -w /etc/netplan/ -p wa -k network_changes

    # Monitor firewall changes
    -w /etc/ufw/ -p wa -k firewall_changes

    # Monitor cron jobs
    -w /etc/crontab -p wa -k cron_changes
    -w /etc/cron.d/ -p wa -k cron_changes
    -w /var/spool/cron/ -p wa -k cron_changes

    # Monitor kernel module loading
    -w /sbin/insmod -p x -k kernel_modules
    -w /sbin/rmmod -p x -k kernel_modules
    -w /sbin/modprobe -p x -k kernel_modules

    # Monitor mount operations
    -a always,exit -F arch=b64 -S mount -k mount_operations
    -a always,exit -F arch=b32 -S mount -k mount_operations

    # Make configuration immutable (requires reboot to change)
    -e 2
    AUDITEOF
  - systemctl enable auditd
  - systemctl restart auditd

  # =========================================================================
  # Sysctl Hardening (65+ Security Parameters)
  # =========================================================================
  - |
    cat > /etc/sysctl.d/99-security-hardening.conf << 'SYSCTLEOF'
    # ==========================================================================
    # Kernel Security Hardening - SOC2/ISO27001 Compliant
    # ==========================================================================

    # --------------------------------------------------------------------------
    # Network Security
    # --------------------------------------------------------------------------

    # Disable IP forwarding (unless needed for Docker networking)
    net.ipv4.ip_forward = 1
    net.ipv6.conf.all.forwarding = 1

    # Disable source routing
    net.ipv4.conf.all.accept_source_route = 0
    net.ipv4.conf.default.accept_source_route = 0
    net.ipv6.conf.all.accept_source_route = 0
    net.ipv6.conf.default.accept_source_route = 0

    # Disable ICMP redirects
    net.ipv4.conf.all.accept_redirects = 0
    net.ipv4.conf.default.accept_redirects = 0
    net.ipv6.conf.all.accept_redirects = 0
    net.ipv6.conf.default.accept_redirects = 0
    net.ipv4.conf.all.secure_redirects = 0
    net.ipv4.conf.default.secure_redirects = 0
    net.ipv4.conf.all.send_redirects = 0
    net.ipv4.conf.default.send_redirects = 0

    # Enable reverse path filtering (anti-spoofing)
    net.ipv4.conf.all.rp_filter = 1
    net.ipv4.conf.default.rp_filter = 1

    # Log martian packets
    net.ipv4.conf.all.log_martians = 1
    net.ipv4.conf.default.log_martians = 1

    # Ignore ICMP broadcast requests
    net.ipv4.icmp_echo_ignore_broadcasts = 1

    # Ignore bogus ICMP error responses
    net.ipv4.icmp_ignore_bogus_error_responses = 1

    # Enable SYN cookies (SYN flood protection)
    net.ipv4.tcp_syncookies = 1

    # TCP hardening
    net.ipv4.tcp_max_syn_backlog = 2048
    net.ipv4.tcp_synack_retries = 2
    net.ipv4.tcp_syn_retries = 5

    # Disable IPv6 if not needed (uncomment to disable)
    # net.ipv6.conf.all.disable_ipv6 = 1
    # net.ipv6.conf.default.disable_ipv6 = 1

    # --------------------------------------------------------------------------
    # Memory Protection
    # --------------------------------------------------------------------------

    # Enable ASLR (Address Space Layout Randomization)
    kernel.randomize_va_space = 2

    # Restrict access to kernel pointers
    kernel.kptr_restrict = 2

    # Restrict dmesg access to root
    kernel.dmesg_restrict = 1

    # Restrict kernel profiling
    kernel.perf_event_paranoid = 3

    # Disable kernel sysrq
    kernel.sysrq = 0

    # Restrict ptrace scope
    kernel.yama.ptrace_scope = 1

    # Core dump restrictions
    fs.suid_dumpable = 0

    # --------------------------------------------------------------------------
    # File System Hardening
    # --------------------------------------------------------------------------

    # Restrict symlink/hardlink following
    fs.protected_symlinks = 1
    fs.protected_hardlinks = 1

    # Restrict FIFO/regular file access
    fs.protected_fifos = 2
    fs.protected_regular = 2

    # Increase inotify limits for file monitoring
    fs.inotify.max_user_watches = 524288
    fs.inotify.max_user_instances = 512

    # --------------------------------------------------------------------------
    # Process Limits
    # --------------------------------------------------------------------------

    # Limit number of PIDs
    kernel.pid_max = 65536

    # Increase file descriptor limits
    fs.file-max = 2097152

    # --------------------------------------------------------------------------
    # Network Performance (also security related)
    # --------------------------------------------------------------------------

    # Increase socket buffer sizes
    net.core.rmem_max = 16777216
    net.core.wmem_max = 16777216
    net.core.rmem_default = 1048576
    net.core.wmem_default = 1048576
    net.core.optmem_max = 65536
    net.core.netdev_max_backlog = 65536

    # TCP memory settings
    net.ipv4.tcp_rmem = 4096 1048576 16777216
    net.ipv4.tcp_wmem = 4096 1048576 16777216
    net.ipv4.tcp_mem = 786432 1048576 26777216

    # Enable TCP window scaling
    net.ipv4.tcp_window_scaling = 1

    # Enable TCP timestamps
    net.ipv4.tcp_timestamps = 1

    # Enable TCP selective acknowledgments
    net.ipv4.tcp_sack = 1

    # TCP keepalive settings
    net.ipv4.tcp_keepalive_time = 600
    net.ipv4.tcp_keepalive_probes = 5
    net.ipv4.tcp_keepalive_intvl = 15

    # Reduce TIME_WAIT connections
    net.ipv4.tcp_fin_timeout = 30
    net.ipv4.tcp_tw_reuse = 1

    # Local port range
    net.ipv4.ip_local_port_range = 1024 65535
    SYSCTLEOF
  - sysctl -p /etc/sysctl.d/99-security-hardening.conf
  # =========================================================================
  # Log Rotation with S3 Archival (ISO A.12.4)
  # =========================================================================
  - mkdir -p /var/log/deploy
  - chmod 750 /var/log/deploy
  - |
    cat > /etc/logrotate.d/deploy-logs << 'LOGEOF'
    /var/log/deploy/*.log {
        daily
        missingok
        rotate 30
        compress
        delaycompress
        notifempty
        create 0640 root root
        sharedscripts
        postrotate
            # Archive to S3 (configure S3_BUCKET in environment)
            if [ -n "$S3_BUCKET" ]; then
                aws s3 cp /var/log/deploy/*.gz s3://$S3_BUCKET/logs/$(hostname)/$(date +%Y/%m/%d)/ || true
            fi
        endscript
    }
    LOGEOF

  # =========================================================================
  # Unattended Upgrades (ISO A.12.6 - Vulnerability Management)
  # =========================================================================
  - |
    cat > /etc/apt/apt.conf.d/50unattended-upgrades << 'UPGRADEEOF'
    Unattended-Upgrade::Allowed-Origins {
        "${distro_id}:${distro_codename}";
        "${distro_id}:${distro_codename}-security";
        "${distro_id}ESMApps:${distro_codename}-apps-security";
        "${distro_id}ESM:${distro_codename}-infra-security";
    };

    Unattended-Upgrade::Package-Blacklist {
    };

    Unattended-Upgrade::DevRelease "auto";
    Unattended-Upgrade::AutoFixInterruptedDpkg "true";
    Unattended-Upgrade::MinimalSteps "true";
    Unattended-Upgrade::Remove-Unused-Kernel-Packages "true";
    Unattended-Upgrade::Remove-Unused-Dependencies "true";
    Unattended-Upgrade::Automatic-Reboot "false";
    Unattended-Upgrade::SyslogEnable "true";
    Unattended-Upgrade::SyslogFacility "daemon";
    UPGRADEEOF
  - |
    cat > /etc/apt/apt.conf.d/20auto-upgrades << 'AUTOEOF'
    APT::Periodic::Update-Package-Lists "1";
    APT::Periodic::Unattended-Upgrade "1";
    APT::Periodic::Download-Upgradeable-Packages "1";
    APT::Periodic::AutocleanInterval "7";
    AUTOEOF
  - systemctl enable unattended-upgrades
  - systemctl start unattended-upgrades

  # =========================================================================
  # Application Directories
  # =========================================================================
  - mkdir -p /opt/app
  - chown deploy:deploy /opt/app
  - chmod 755 /opt/app

  # Mount encrypted data volume (if attached)
  - |
    if [ -b /dev/sda ]; then
        # Format if not already formatted
        if ! blkid /dev/sda; then
            mkfs.ext4 -L app-data /dev/sda
        fi
        mkdir -p /data
        echo '/dev/sda /data ext4 defaults,noatime 0 2' >> /etc/fstab
        mount /data
        chown deploy:deploy /data
        chmod 755 /data
    fi

  # =========================================================================
  # Final Status
  # =========================================================================
  - |
    echo "=========================================="
    echo "Cloud-init security hardening complete"
    echo "=========================================="
    echo "SOC2 CC6.1: SSH key-only auth - ENABLED"
    echo "SOC2 CC6.6: UFW firewall - ENABLED"
    echo "SOC2 CC6.7: Fail2ban - ENABLED"
    echo "SOC2 CC7.1: Auditd - ENABLED"
    echo "ISO A.12.6: Unattended upgrades - ENABLED"
    echo "=========================================="

# Write a completion marker
final_message: Cloud-init completed with SOC2/ISO27001 security hardening
